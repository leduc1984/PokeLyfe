paper.install(window)
$(function(){
    var dx = 3;
    var dy = 3;
    paper.setup("mycanvas");
    var new_pt = new Point(0, 0);
    var current_pt, rect, path;
    var first_time = true;
    // var current_pt = new Point(50, 50);
    // var new_pt = new Point(50, 50);
    
    // var rect = new Rectangle(current_pt, 100, 100);
    // var path = new Path.Rectangle(rect);
    // path.strokeColor = 'red';
    var tool = new Tool();
    var keysdown = {}
    tool.onKeyDown = function(event){
	keysdown[event.key] = true;
	$.ajax({
	    url:"keydown",
	    data:keysdown
	});
    }
    tool.onKeyUp = function(event){
	keysdown[event.key] = false;
    }
    view.onFrame = function (event){
	$.ajax({
	    url:"myposition"
	}).done(function(data){
	    new_pt.x = data.x;
	    new_pt.y = data.y;
	    if (first_time){
		current_pt = new_pt.clone();
	    }
	});
	console.log("onFrame");
	var xdist = new_pt.x - current_pt.x;
	var ydist = new_pt.y - current_pt.y;
	if (Math.abs(xdist) > dx){
	    current_pt.x += dx * xdist/Math.abs(xdist);
	}
	if (Math.abs(ydist) > dy){
	    current_pt.y += dy * ydist/Math.abs(ydist);
	}
	if(!first_time)
	    path.remove();
	else
	    first_time = false;
	rect = new Rectangle(current_pt, 100, 100);
	path = new Path.Rectangle(rect);
	path.fillColor='red';
	path.strokeColor='black';
	path.strokeWidth=5;
    }
    tool.activate();
});
